---
  - name: Cephadmin post bootstrap
    hosts: cephadmin
    become: true
    tasks:
      - name: Print output of inventory
        ansible.builtin.debug:
          msg: "hostname {{ host_name }}, ip address: {{ ip_address }}"
        vars:
          ip_address: "{{ hostvars[item]['ansible_host'] }}"
          host_name: "{{ hostvars[item]['inventory_hostname'] }}"
        with_items: "{{ groups['myvms'] }}"

      - name: Copy ssh keys to hosts with ssh-copy-id
        ansible.builtin.shell: |
          ssh-copy-id -f -i /etc/ceph/ceph.pub -o StrictHostKeyChecking=no  {{ cephusername }}@{{ item }}.{{ domain }}
        args:
          chdir: /usr/share/cephadm-ansible/
        with_items: "{{ groups['myvms'] }}"

      - name: List hosts in current ceph cluster
        ansible.builtin.shell: |
          ceph orch host ls
        args:
          chdir: /usr/share/cephadm-ansible/
        register: ceph_orch_host_ls_before

      - name: Print output of host listing
        ansible.builtin.debug:
          var: ceph_orch_host_ls_before

      - name: Add ceph nodes to cluster and assign roles
        ansible.builtin.shell: |
          echo "Working on: {{ host_name }}"
          ceph orch host add {{ host_name }} {{ ip_address }}
          {% if 'ceph-' in  host_name %}
          echo "Assigning roles to ceph node {{ host_name }}"
            {% if 'osd' in ceph_roles %}
            echo "Assigning osd role to {{ host_name }}"
            ceph orch host label add {{ host_name }} osd
            {% endif %}
            {% if 'mon' in ceph_roles %}
            echo "Assigning mon role to {{ host_name }}"
            ceph orch host label add {{ host_name }} mon
            {% endif %}
            {% if 'mgr' in ceph_roles %}
            echo "Assigning mgr role to {{ host_name }}"
            ceph orch host label add {{ host_name }} mgr
            {% endif %}
            {% if 'mds' in ceph_roles %}
            echo "Assigning mds role to {{ host_name }}"
            ceph orch host label add {{ host_name }} mds
            {% endif %}
            {% if 'rgw' in ceph_roles %}
            echo "Assigning rgw role to {{ host_name }}"
            ceph orch host label add {{ host_name }} rgw
            {% endif %}
          {% endif %}
        args:
          chdir: /usr/share/cephadm-ansible/
        vars:
          ip_address: "{{ hostvars[item]['ansible_host'] }}"
          host_name: "{{ hostvars[item]['inventory_hostname'] }}"  
          ceph_roles: "{{ hostvars[item]['ceph_roles'] }}"
        with_items: "{{ groups['myvms'] }}"
        register: assign_roles

      - name: Print output of adding and assigning roles
        ansible.builtin.debug:
          var: assign_roles

      - name: List hosts and apply roles        
        ansible.builtin.shell: |
          ceph orch apply mon --placement="*"
          ceph orch apply mgr --placement="*"
          ceph orch apply osd --all-available-devices
          ceph orch host ls
        args:
          chdir: /usr/share/cephadm-ansible/
        register: ceph_orch_host_ls_after
          
      - name: Print output of host listing and role application
        ansible.builtin.debug:
          var: ceph_orch_host_ls_after
       
            #        # https://docs.ceph.com/en/reef/cephadm/services/rgw/
            #      - name: Configure Rados Gateway    
            #        ansible.builtin.shell: |
            #          #radosgw-admin realm create --rgw-realm=momolab --default
            #          #radosgw-admin zonegroup create --rgw-zonegroup=momolab  --master --default
            #          #radosgw-admin zone create --rgw-zonegroup=momolab --rgw-zone=momolab --master --default
            #          #radosgw-admin period update --rgw-realm=momolab --commit
            #          ceph orch apply rgw momolab #--realm=momolab --zone=momolab --placement="*"
            #     
            #      - name: Configure RGW (Rados Gateway) settings
            #        ansible.builtin.shell: |
            #          echo "Configuring Ceph RGW service"
            #          ceph config set client.rgw.frontend "civetweb"  # or nginx if preferred
            #          ceph config set client.rgw.civetweb_port {{ rgw_port }}
            #          ceph config set client.rgw.ssl_certificate /root/.ssh/id_rsa.pub   # Specify SSL cert if using HTTPS
            #          ceph config set client.rgw.ssl_private_key /root/.ssh/id_rsa   # Specify SSL private key if using HTTPS
            #        
            #      - name: Check RGW status
            #        ansible.builtin.shell: |
            #          echo "Checking Ceph RGW service status"
            #          ceph orch ps --service {{ rgw_service_name }}
            #        
            #      - name: Expose RGW API (optional - if you need an external endpoint)
            #        ansible.builtin.shell: |
            #          echo "Exposing RGW API externally via a load balancer or directly"
            #          ufw allow {{ rgw_port }}

      - name: Copy the ceph-external-cluster-details-exporter.py tp /root
        ansible.builtin.copy:
          src: ../files/ceph-external-cluster-details-exporter.py
          dest: /root/
          mode: '755'


