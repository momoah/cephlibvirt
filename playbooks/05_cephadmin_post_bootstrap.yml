---
  - name: Cephadmin post bootstrap
    hosts: cephadmin
    become: true
    tasks:
      - name: Print output of inventory
        ansible.builtin.debug:
          msg: "hostname {{ host_name }}, ip address: {{ ip_address }}"
        vars:
          ip_address: "{{ hostvars[item]['ansible_host'] }}"
          host_name: "{{ hostvars[item]['inventory_hostname'] }}"
        with_items: "{{ groups['myvms'] }}"

      - name: Copy ssh keys to hosts with ssh-copy-id
        ansible.builtin.shell: |
          ssh-copy-id -f -i /etc/ceph/ceph.pub -o StrictHostKeyChecking=no  {{ cephusername }}@{{ item }}.{{ domain }}
        args:
          chdir: /usr/share/cephadm-ansible/
        with_items: "{{ groups['myvms'] }}"

      - name: List hosts in current ceph cluster
        ansible.builtin.shell: |
          ceph orch host ls
        args:
          chdir: /usr/share/cephadm-ansible/
        register: ceph_orch_host_ls_before

      - name: Print output of host listing
        ansible.builtin.debug:
          var: ceph_orch_host_ls_before

      - name: Add ceph nodes to cluster and assign roles
        ansible.builtin.shell: |
          echo "Working on: {{ host_name }}"
          ceph orch host add {{ host_name }} {{ ip_address }}
          {% if 'ceph-' in  host_name %}
          echo "Assigning roles to ceph node {{ host_name }}"
            {% if 'osd' in ceph_roles %}
            echo "Assigning osd role to {{ host_name }}"
            ceph orch host label add {{ host_name }} osd
            {% endif %}
            {% if 'mon' in ceph_roles %}
            echo "Assigning mon role to {{ host_name }}"
            ceph orch host label add {{ host_name }} mon
            {% endif %}
            {% if 'mgr' in ceph_roles %}
            echo "Assigning mgr role to {{ host_name }}"
            ceph orch host label add {{ host_name }} mgr
            {% endif %}
            {% if 'mds' in ceph_roles %}
            echo "Assigning mds role to {{ host_name }}"
            ceph orch host label add {{ host_name }} mds
            {% endif %}
            {% if 'rgw' in ceph_roles %}
            echo "Assigning rgw role to {{ host_name }}"
            ceph orch host label add {{ host_name }} rgw
            {% endif %}
          {% endif %}
        args:
          chdir: /usr/share/cephadm-ansible/
        vars:
          ip_address: "{{ hostvars[item]['ansible_host'] }}"
          host_name: "{{ hostvars[item]['inventory_hostname'] }}"  
          ceph_roles: "{{ hostvars[item]['ceph_roles'] }}"
        with_items: "{{ groups['myvms'] }}"
        register: assign_roles

      - name: Print output of adding and assigning roles
        ansible.builtin.debug:
          var: assign_roles

      - name: List hosts and apply roles        
        ansible.builtin.shell: |
          ceph orch apply mon --placement="*"
          ceph orch apply mgr --placement="*"
          ceph orch apply rgw --placement="cephadmin"
          ceph orch apply osd --all-available-devices
          ceph orch host ls
        args:
          chdir: /usr/share/cephadm-ansible/
        register: ceph_orch_host_ls_after
          
      - name: Print output of host listing and role application
        ansible.builtin.debug:
          var: ceph_orch_host_ls_after
       
      - name: Copy the ceph-external-cluster-details-exporter.py tp /root
        ansible.builtin.copy:
          src: ../files/ceph-external-cluster-details-exporter.py
          dest: /root/
          mode: '755'

      - name: Setup self signed SSL for secure rados gateway
        ansible.builtin.shell: |
          mkdir -p /etc/ceph/ssl
          cd /etc/ceph/ssl
          openssl req -x509 -newkey rsa:4096 -keyout rgw.key -out rgw.crt -days 825 -nodes \
          -subj "/C=AU/O=Momolab/CN={{ rgw_host }}" \
          -addext "subjectAltName=DNS:{{ rgw_host }}" \
          -addext "extendedKeyUsage=serverAuth"
        args:
          chdir: /usr/share/cephadm-ansible/
        register: selfsignedssl

      - name: Print output of selfsignedssl
        ansible.builtin.debug:
          var: selfsignedssl
  
      - name: Setup cephadmin to be an secure rados gateway
        ansible.builtin.shell: |
          ceph orch apply rgw rados --realm {{ rgw_realm }} --zonegroup {{ rgw_realm }} --zone {{ rgw_zone }} --placement="1 cephadmin"
          ceph orch restart rgw.rados
          ceph config-key set rgw/cert/default/default.crt -i /etc/ceph/ssl/rgw.crt
          ceph config-key set rgw/cert/default/default.key -i /etc/ceph/ssl/rgw.key
          ceph config set client.rgw.rados rgw_frontends \
          "beast ssl_port={{ rgw_port }} ssl_certificate=config://rgw/cert/{{ rgw_realm }}/{{ rgw_zone }}.crt \
           ssl_private_key=config://rgw/cert/{{ rgw_realm }}/{{ rgw_zone }}.key"
          ceph orch restart rgw.rados
          cephadm shell -- radosgw-admin user info --uid=openshift >/dev/null 2>&1 || \
          cephadm shell -- radosgw-admin user create --uid=openshift --display-name="OpenShift S3"
        args:
          chdir: /usr/share/cephadm-ansible/
        register: rgw_setup

      - name: Print output of Rados gateway setup
        ansible.builtin.debug:
          var: rgw_setup

